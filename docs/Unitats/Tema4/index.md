# Tema 4. Organitzaci√≥ i consulta de la informaci√≥

```{toctree}
:maxdepth: 2
:caption: Continguts del Tema 4
:hidden:

```

## Introducci√≥

En el **Tema 3** hem automatitzat completament la instal¬∑laci√≥ d‚ÄôOdoo en una m√†quina virtual mitjan√ßant Docker.  A hores d‚Äôara ja disposem d‚Äôun servidor amb tres contenidors principals:

- **Odoo** (aplicaci√≥ web)  
- **PostgreSQL** (base de dades)  
- **MailHog** (servidor de correu de proves)

Ara anem un pas m√©s enll√†: aprendrem a **consultar directament la base de dades d‚ÄôOdoo** utilitzant un client gr√†fic anomenat **pgAdmin**, i tamb√© veurem com identificar les taules i camps on Odoo desa la informaci√≥.

---

## üéØ Objectius

- Entendre com es connecta Odoo a la seua base de dades PostgreSQL.  
- Configurar un acc√©s remot **persistent** al contenidor de base de dades.  
- Instal¬∑lar i configurar **pgAdmin** a la m√†quina virtual.  
- Visualitzar taules, dades i usuaris de PostgreSQL.  
- Comprendre la correspond√®ncia entre models d‚ÄôOdoo i taules SQL.

---

## üß© Acc√©s a la base de dades amb pgAdmin

Odoo utilitza **PostgreSQL** com a sistema gestor de base de dades (SGBD).  
Les dades de clients, productes, factures, etc., s‚Äôemmagatzemen en **centenars de taules** dins del contenidor `db`.  Podem accedir-hi amb dos tipus d‚Äôeines:

- **psql** ‚Äî client de l√≠nia d‚Äôordres per a usuaris avan√ßats.  
- **pgAdmin** ‚Äî client gr√†fic multiplataforma amb interf√≠cie visual.

---

### üîß Configuraci√≥ persistent per a la connexi√≥ remota

Per defecte, PostgreSQL nom√©s accepta connexions locals.  A m√©s, si modifiquem els fitxers de configuraci√≥ **dins del contenidor**, aquests canvis **no s√≥n persistents**: es perden cada vegada que es recrea el contenidor. Per aix√≤, en el nostre **script d‚Äôautomatitzaci√≥ (`setup_odoo.sh`)** hem afegit un pas per crear una carpeta amb els fitxers de configuraci√≥ de PostgreSQL i incloure-la com a volum en el directori especial `/docker-entrypoint-initdb.d`.  
D‚Äôaquesta manera, els fitxers s‚Äôapliquen autom√†ticament **la primera vegada que s‚Äôinicialitza la base de dades** i es conserven despr√©s, sense interferir amb el volum de dades (`/var/lib/postgresql/data`).

#### Just abans de la l√≠nia on es crea el docker-compose.yml, afegeix aquest bloc:
```bash
# Carpeta de configuraci√≥ persistent per a PostgreSQL
mkdir -p "$PROJECT_DIR/db_config"

# Crear fitxers de configuraci√≥ per defecte si no existeixen
if [ ! -f "$PROJECT_DIR/db_config/pg_hba.conf" ]; then
cat > "$PROJECT_DIR/db_config/pg_hba.conf" <<'EOF'
# TYPE  DATABASE        USER            ADDRESS                 METHOD
local   all             all                                     peer
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5
# Connexions des de qualsevol IP amb contrasenya
host    all             all             0.0.0.0/0               md5
EOF
fi

if [ ! -f "$PROJECT_DIR/db_config/postgresql.conf" ]; then
cat > "$PROJECT_DIR/db_config/postgresql.conf" <<'EOF'
listen_addresses = '*'
max_connections = 100
shared_buffers = 128MB
logging_collector = on
log_directory = '/var/lib/postgresql/data/logs'
log_filename = 'postgresql.log'
EOF
fi
```

---

#### 1Ô∏è‚É£ Creaci√≥ autom√†tica de la carpeta `db_config`

L‚Äôscript crea aquesta estructura dins del projecte:

```
~/odoo_server/db_config/
```

I genera autom√†ticament dos fitxers si no existeixen:  
`pg_hba.conf` i `postgresql.conf` (vegeu el contingut anterior).

> üß† **Per qu√® √©s necessari?**  
> Sense aquesta carpeta externa, els fitxers de configuraci√≥ estarien dins del contenidor i es perdrien en qualsevol reconstrucci√≥. Amb aquest volum, Docker pot reaplicar la configuraci√≥ i permet conservar-la entre reinicis.

---

#### 2Ô∏è‚É£ Modificaci√≥ del `docker-compose.yml`

En el servei `db`, s‚Äôha afegit el muntatge de la carpeta `db_config` com a volum:

```yaml
  db:
    image: postgres:latest
    environment:
      - POSTGRES_DB=postgres
      - POSTGRES_PASSWORD=myodoo
      - POSTGRES_USER=odoo
      - PGDATA=/var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      # Carpeta de dades (persistent)
      - odoo-db-data:/var/lib/postgresql/data/pgdata
      # Fitxers de configuraci√≥ inicials (s'apliquen nom√©s en la primera inicialitzaci√≥)
      - ./db_config:/docker-entrypoint-initdb.d
    restart: always
```


:::{admonition} Com funciona `/docker-entrypoint-initdb.d` en PostgreSQL (Docker)
:class: tip

Quan s‚Äôutilitza la **imatge oficial de PostgreSQL** en Docker, aquesta incorpora un script d‚Äôentrada que s‚Äôexecuta autom√†ticament cada vegada que arranca el contenidor.  Aquest script comprova si el volum de dades (üìÇ `/var/lib/postgresql/data`) est√† **buit** ‚Äî √©s a dir, si la base de dades encara no existeix.

Si √©s la **primera inicialitzaci√≥**, PostgreSQL:

1Ô∏è‚É£ Llig tots els fitxers que hi haja al directori especial `/docker-entrypoint-initdb.d`.  
2Ô∏è‚É£ Executa autom√†ticament:
   - Els `.sh` com a scripts de shell.  
   - Els `.sql` amb el client `psql`.  
   - I **copia** els fitxers `.conf` (com `postgresql.conf` o `pg_hba.conf`) al seu lloc dins `/var/lib/postgresql/data/`. 
 
3Ô∏è‚É£ Una vegada inicialitzada la base de dades, aquest proc√©s **no es torna a repetir** fins que s‚Äôesborre el volum.

üì¶ **Aix√≤ vol dir que:**
- Pots inicialitzar PostgreSQL amb configuracions pr√≤pies sense tocar la imatge base.  
- Els canvis dins `db_config/` nom√©s s‚Äôapliquen en la **primera execuci√≥** (quan encara no hi ha dades).  
- Si vols reaplicar-los, pots eliminar el volum de dades amb:
  ```bash
  docker compose down -v
  docker compose up -d
  ```


>üí° Resum:
>El directori `/docker-entrypoint-initdb.d` √©s com una ‚Äúcarpeta de scripts d‚Äôinicialitzaci√≥‚Äù. Nom√©s actua la primera vegada, abans que PostgreSQL cree la seua base de dades interna, i et permet automatitzar la configuraci√≥ sense tocar el contenidor manualment.


:::


> ‚ö†Ô∏è Si edites els fitxers dins del contenidor (i no al volum `db_config`), aquests canvis es perdran.  
> Per aix√≤ sempre √©s recomanable mantindre `pg_hba.conf` i `postgresql.conf` **fora del contenidor** (a `~/odoo_server/db_config/`).  


```{dropdown} üîß  **Si necessites modificar-los temporalment des de dins del contenidor**, pots seguir aquests passos:
:icon: wrench
:class: dropdown

> 1Ô∏è‚É£ **Accedeix al contenidor de PostgreSQL:**
> ```bash
> docker exec -it odoo_server-db-1 bash
> ```
> 2Ô∏è‚É£ **Edita els fitxers de configuraci√≥** a `/var/lib/postgresql/data/`:
> - `pg_hba.conf`
> - `postgresql.conf`
>
> 3Ô∏è‚É£ **Afegeix al fitxer `pg_hba.conf`:**
> ```bash
> host all all 0.0.0.0/0 md5
> ```
> (Permet connexions remotes autenticades amb contrasenya.)
>
> 4Ô∏è‚É£ **Modifica `postgresql.conf`** i assegura‚Äôt que cont√©:
> ```bash
> listen_addresses = '*'
> ```
> (El servidor escoltar√† peticions des de qualsevol IP.)
>
> 5Ô∏è‚É£ **Reinicia el contenidor per aplicar els canvis:**
> ```bash
> exit
> docker restart odoo_server-db-1
> ```
> üîÅ Recorda: aquests canvis **no s√≥n persistents** ‚Äî es perdran si el contenidor es recrea.  
> Per fer-los permanents, cal aplicar-los als fitxers del volum `~/odoo_server/db_config/`.

```

Ara el contenidor `db` acceptar√† connexions externes pel port **5432**, i la configuraci√≥ es mantindr√† fins i tot despr√©s de reinicis o reconstruccions.



---

#### 3Ô∏è‚É£ Reinici del servei PostgreSQL

Hi ha dues situacions possibles:

- **Recreaci√≥ completa:**  
  Si has modificat `setup_odoo.sh` o vols reiniciar completament la configuraci√≥:
  ```bash
  cd ~/odoo_server
  docker compose down -v
  ./setup_odoo.sh
  ```
  Aix√≤ eliminar√† el volum persistent i generar√† una base de dades neta amb la nova configuraci√≥.

- **Nom√©s reiniciar el contenidor:**  
  Si nom√©s has canviat els fitxers `db_config`:
  ```bash
  cd ~/odoo_server
  docker compose restart db
  # o, si cal, for√ßa la recreaci√≥:
  docker compose up -d --force-recreate db
  ```

---

## üíª Instal¬∑laci√≥ de pgAdmin en Ubuntu (sense entorn gr√†fic)

Com que treballem dins d‚Äôuna **m√†quina virtual Ubuntu 24.04** sense interf√≠cie gr√†fica, no podem instal¬∑lar la versi√≥ d‚Äôescriptori de pgAdmin.  En el seu lloc, instal¬∑larem la **versi√≥ web (pgAdmin4)**, que es gestiona des del navegador.

### 1Ô∏è‚É£ Instal¬∑lar depend√®ncies b√†siques

Actualitzem els paquets i instal¬∑lem les depend√®ncies necess√†ries:

```bash
sudo apt update
sudo apt install -y curl ca-certificates gnupg
```

---

### 2Ô∏è‚É£ Afegir el repositori oficial de pgAdmin

Descarreguem i registrem la clau p√∫blica del repositori de PostgreSQL:

```bash
curl https://www.pgadmin.org/static/packages_pgadmin_org.pub | sudo gpg --dearmor -o /usr/share/keyrings/pgadmin-keyring.gpg
```

Afegim el repositori a la nostra llista d‚Äôor√≠gens:

```bash
echo "deb [signed-by=/usr/share/keyrings/pgadmin-keyring.gpg] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/noble pgadmin4 main" | sudo tee /etc/apt/sources.list.d/pgadmin4.list > /dev/null
```

> üß© *Nota:* en Ubuntu 24.04 el nom en clau √©s **noble**, per aix√≤ usem aquest valor.

---

### 3Ô∏è‚É£ Instal¬∑lar pgAdmin4 en mode servidor

```bash
sudo apt update
sudo apt install -y pgadmin4-web
```

>üí° Nota important (Ubuntu 24.04 ‚Äúnoble‚Äù):
>La instal¬∑laci√≥ del paquet no llan√ßa autom√†ticament l‚Äôassistent de configuraci√≥ del servidor web. Cal executar-lo manualment amb la seg√ºent ordre:

```bash
sudo /usr/pgadmin4/bin/setup-web.sh
```

Durant aquest proc√©s:
  - Se‚Äôt demanar√† crear un usuari administrador (adre√ßa de correu i contrasenya).
  - Es configurar√† autom√†ticament Apache i el m√≤dul wsgi per a servir pgAdmin4.
  - El sistema et preguntar√† si vols reiniciar Apache per aplicar els canvis.

Quan tot acabe correctament, apareixer√† un missatge com aquest:

```bash
Apache successfully restarted. You can now start using pgAdmin 4 in web mode at http://127.0.0.1/pgadmin4
```


:::{dropdown}  üíæ Espai esgotat en la m√†quina virtual: com ampliar el disc LVM (Ubuntu)
:icon: wrench
:class: dropdown
:class: tip

√âs molt habitual que aparega l‚Äôerror:

  ```bash
  sqlite3.OperationalError: database or disk is full
  ``` 

encara que el disc virtual (.vdi) tinga molts GB disponibles.  
Aix√≤ passa perqu√® **Ubuntu instal¬∑la per defecte amb LVM**, i el volum l√≤gic del sistema (`ubuntu-lv`) nom√©s ocupa una part del disc virtual.

---

### üß© 1Ô∏è‚É£ Comprovaci√≥ inicial

Mostra l‚Äôespai real utilitzat dins la m√†quina virtual:

```bash
df -h
```

Si veus alguna l√≠nia com:

```bash
/dev/mapper/ubuntu--vg-ubuntu--lv   11G   11G     0 100% /
```

vol dir que el volum l√≤gic nom√©s t√© 11 GB encara que el `.vdi` siga m√©s gran (p. ex. 25 GB).

---

### ‚öôÔ∏è 2Ô∏è‚É£ Ampliar el volum l√≤gic per utilitzar tot l‚Äôespai del disc

Executa aquestes ordres dins de la m√†quina virtual:

```bash
sudo lvextend -l +100%FREE /dev/ubuntu-vg/ubuntu-lv
sudo resize2fs /dev/ubuntu-vg/ubuntu-lv
```

- `lvextend` assigna tot l‚Äôespai lliure del disc al volum l√≤gic.  
- `resize2fs` expandeix el sistema de fitxers per aprofitar-lo.

---

### ‚úÖ 3Ô∏è‚É£ Verifica l‚Äôexpansi√≥

Torna a comprovar l‚Äôespai amb:

```bash
df -h
```

Ara hauries de veure alguna cosa semblant a:

```bash
/dev/mapper/ubuntu--vg-ubuntu--lv   25G   11G   14G   45% /
```

A partir d‚Äôaquest moment el sistema ja disposa de tot l‚Äôespai del disc virtual.

---

### üí° 4Ô∏è‚É£ En cas de no tindre m√©s espai assignat al disc virtual

Si continues al 100 %, pots **augmentar la mida del `.vdi`** des de VirtualBox:

1. Apaga la m√†quina virtual.  
2. En **Configuraci√≥ ‚Üí Emmagatzematge ‚Üí Dispositiu SATA ‚Üí OdooServer-Docker.vdi**, augmenta la mida (p. ex. de 25 GB a 40 GB).  
3. Torna a iniciar la VM i repeteix els passos anteriors (`lvextend` i `resize2fs`).

---

Amb aix√≤, el teu Ubuntu aprofitar√† tot l‚Äôespai disponible i deixar√† d‚Äôapar√©ixer l‚Äôerror `database or disk is full` en pgAdmin4 o altres aplicacions.
:::
---

## 4Ô∏è‚É£ Accedir a pgAdmin4 des del navegador

Una vegada finalitzada la configuraci√≥ amb `sudo /usr/pgadmin4/bin/setup-web.sh`, podem obrir pgAdmin4 des del navegador web dins de la m√†quina virtual (si t√© entorn gr√†fic) o des del nostre ordinador amfitri√≥ mitjan√ßant **redirecci√≥ de ports**.

---

### üß≠ Cas 1: Xarxa NAT amb redirecci√≥ de ports (VirtualBox)

Com que la m√†quina virtual est√† configurada en **mode NAT**, cal crear una regla de redirecci√≥ per permetre l‚Äôacc√©s al port `8080` (pgAdmin4) des del nostre ordinador host.

A VirtualBox:
1Ô∏è‚É£ Obri la configuraci√≥ de la m√†quina virtual ‚Üí **Xarxa ‚Üí Avan√ßat ‚Üí Redirecci√≥ de ports**  
2Ô∏è‚É£ Afig una nova regla:

| Nom         | Protocol | IP de l‚Äôamfitri√≥ | Port de l‚Äôamfitri√≥ | IP del client | Port del client |
|--------------|-----------|-----------------|--------------------|----------------|-----------------|
| pgadmin4     | TCP       | 127.0.0.1       | 8080               | 10.0.2.15      | 80           |

> üí° Aix√≤ permet que quan accedim a `http://127.0.0.1:8080` al nostre navegador, el tr√†nsit es redirigisca al port `80` de la m√†quina virtual (10.0.2.15).

```{image} /_static/assets/img/Tema4/pgadmin-4.png
:alt: pgadmin-4
:width: 80%
:align: center
```

---

### üß≠ Cas 2: Xarxa pont (bridged)

Si la m√†quina virtual est√† en xarxa **bridged (pont)**, simplement accedim directament a la seua IP dins de la xarxa local.

üëâ Exemple:
:::bash
http://192.168.56.10:8080/pgadmin4
:::

---

### üîê Autenticaci√≥

Autentica‚Äôt amb l‚Äôusuari creat durant el proc√©s de configuraci√≥ (`setup-web.sh`):

- **Usuari (email):** el que vas introduir durant la configuraci√≥  
- **Contrasenya:** la que vas definir

Despr√©s d‚Äôiniciar sessi√≥, ja podr√†s afegir una connexi√≥ al servidor PostgreSQL del teu entorn Docker (contenidor `db`).

---

### ‚öôÔ∏è Exemple d‚Äôacc√©s des del host

Amb la redirecci√≥ de ports configurada com a dalt, des del teu navegador (al teu ordinador host) pots accedir-hi amb:

:::bash
http://127.0.0.1:8080/pgadmin4
:::

Aix√≤ obrir√† la interf√≠cie web de pgAdmin4, servida per la m√†quina virtual Ubuntu mitjan√ßant Apache i WSGI.

---

### 5Ô∏è‚É£ Connexi√≥ amb el contenidor de PostgreSQL

```{image} /_static/assets/img/Tema4/pgadminnuevo.png
:alt: pgadminnuevo
:width: 80%
:align: center
```

Una vegada dins de pgAdmin4, creem una nova connexi√≥ amb el servidor Docker:

- **Nom:** Odoo Docker  
- **Host:** `localhost` o la IP de la m√†quina virtual  
- **Port:** `5432`  
- **Usuari:** `odoo`  
- **Contrasenya:** `myodoo` (segons el `docker-compose.yml`).

Amb aix√≤, ja podem explorar la base de dades `cpa` creada per Odoo dins del contenidor PostgreSQL.


```{image} /_static/assets/img/Tema4/pgadminnuevoconfig.png
:alt: pgadminnuevoconfig
:width: 80%
:align: center
```

---
### üß≠ Interf√≠cie de pgAdmin4

Quan accedim a pgAdmin4, podem vore totes les bases de dades disponibles dins del servidor PostgreSQL.  
Per defecte, apareixen dues:

| Nom de la base de dades | Origen | Funci√≥ | Pots esborrar-la? |
|--------------------------|---------|--------|-------------------|
| **postgres** | Base de dades creada autom√†ticament per PostgreSQL | S‚Äôutilitza per a connexions administratives o proves. No cont√© dades d‚ÄôOdoo. | ‚ùå No recomanat |
| **cpa** | Base de dades creada per Odoo en la instal¬∑laci√≥ inicial | Cont√© totes les taules, esquemes i dades reals del projecte Odoo. | ‚úÖ √âs la base principal |

> ‚ö†Ô∏è **Atenci√≥:** no confongues la base `postgres` amb la base del projecte Odoo.  
> Totes les dades √∫tils es troben dins de la base **`cpa`**.

---

### üìä Panell de control de pgAdmin

Des de la pestanya **Tablero** (Dashboard), pgAdmin mostra informaci√≥ en temps real sobre l‚Äôactivitat de la base de dades:

- **Sessions actives** i connexions obertes.  
- **Transaccions per segon** (cometre/retrocedir).  
- **Lectures i escriptures** de blocs de dades.  
- **Insercions, actualitzacions i esborrats** recents.

```{image} /_static/assets/img/Tema4/pgadmintablero.png
:alt: pgadmintablero
:width: 100%
:align: center
```

> üí° Aquesta vista √©s molt √∫til per comprovar si Odoo est√† interactuant correctament amb la base de dades: cada vegada que un usuari inicia sessi√≥ o crea un registre, veur√†s activitat al gr√†fic.


> üí° **Avantatge:** la versi√≥ web de pgAdmin √©s molt m√©s lleugera i permet treballar en m√†quines sense entorn gr√†fic, accedint-hi f√†cilment des d‚Äôun navegador o des d‚Äôuna altra m√†quina de la mateixa xarxa.

> ‚ö†Ô∏è Nota important sobre la xarxa (NAT + port forwarding)
> - Estem en una m√†quina virtual amb NAT i redirecci√≥ de ports. Des del teu ordinador accedeixes sempre per localhost (host), i el hipervisor redirigeix cap a la VM.
> - Perqu√® la redirecci√≥ funcione, dins de la VM els serveis han d‚Äôescoltar a 0.0.0.0 (o a la IP de la interf√≠cie), no nom√©s a 127.0.0.1.
> - La millor recomanaci√≥ de seguretat en aquest escenari √©s limitar la redirecci√≥ del costat host a 127.0.0.1 perqu√® nom√©s el teu equip puga entrar, i dins de la VM restringir l‚Äôorigen amb UFW i pg_hba.conf.

### üìã Exploraci√≥ de la base de dades d‚ÄôOdoo

Una vegada connectats, veurem totes les bases de dades disponibles.  
Seleccionem la que hem creat (per exemple, `cpa`) per explorar-ne les taules:

```{image} /_static/assets/img/Tema4/img4-T4.png
:alt: img4-T4
:width: 100%
:align: center
```

Odoo utilitza un esquema per a cada m√≤dul instal¬∑lat:  
- Les taules del m√≤dul *website* comencen per `website_`.  
- Les del m√≤dul *sale* per `sale_`.  
- Les del m√≤dul *crm* per `crm_`, etc.

```{image} /_static/assets/img/Tema4/img5-T4.png
:alt: img5-T4
:width: 100%
:align: center
```

Podem veure els **camps de cada taula**:

```{image} /_static/assets/img/Tema4/img6-T4.png
:alt: img6-T4
:width: 100%
:align: center
```

I tamb√© **consultar les dades** fent la consulta corresponent:

```{image} /_static/assets/img/Tema4/img8-T4.png
:alt: img8-T4
:width: 100%
:align: center
```

Aix√≠ visualitzem, per exemple, els productes registrats a Odoo.

---

### üë• Gesti√≥ d‚Äôusuaris de PostgreSQL

Tamb√© podem veure i modificar els usuaris existents des del men√∫ lateral:

```{image} /_static/assets/img/Tema4/img9_T4.png
:alt: img9_T4
:width: 25%
:align: center
```

L‚Äôusuari per defecte amb el qual Odoo es connecta √©s **odoo**.

```{image} /_static/assets/img/Tema4/img10_T4.png
:alt: img10_T4
:width: 70%
:align: center
```

Des de *Propietats* podem revisar permisos i contrasenyes:

```{image} /_static/assets/img/Tema4/img11-T4.png
:alt: img11-T4
:width: 100%
:align: center
```

---

### üåê Consulta des del client web d‚ÄôOdoo

Finalment, recorda que podem accedir a les mateixes dades tamb√© des del **client web d‚ÄôOdoo**, per√≤ de manera estructurada i segura, mitjan√ßant les seues vistes i models.

Odoo segueix el patr√≥ **MVC (Model‚ÄìVista‚ÄìControlador):**

- **Model** ‚Üí taules SQL (classes Python)  
- **Vista** ‚Üí fitxers XML que defineixen formularis, llistes o cerques  
- **Controlador** ‚Üí l√≤gica Python que gestiona les accions de l‚Äôusuari

Aquesta arquitectura permet mantenir separats les dades i el disseny de la interf√≠cie.

---

## üß† Resum

En aquest tema hem apr√©s a:

- Configurar **PostgreSQL per a connexions remotes persistents**.  
- Utilitzar **pgAdmin** per explorar i administrar la base de dades d‚ÄôOdoo.  
- Recon√©ixer les **taules, camps i usuaris principals** del sistema.  
- Entendre la relaci√≥ entre **models Python i taules SQL** dins d‚ÄôOdoo.  

Amb tot aix√≤, ja pots **analitzar i comprendre les dades internes d‚ÄôOdoo** tant des del client web com des d‚Äôuna eina professional com *pgAdmin*.

---
:::{dropdown}  ‚úÖ Configuraci√≥ recomanada (resum)
:icon: wrench
:class: dropdown
:class: tip 


**1. Regles de port forwarding (VirtualBox/VMware):**  

```{admonition} üí° Recomanaci√≥ de xarxa (entorn d‚Äôaula ‚Äî NAT + port forwarding)
:class: note
- Accedeix des del teu ordinador a: `localhost:8069`, `localhost:5050`, `localhost:5432` o `localhost:8025`.  
- En el gestor de la m√†quina virtual, configura les regles de *port forwarding* amb **Host IP = 127.0.0.1** per a limitar l‚Äôacc√©s al teu propi equip.  
- Dins la VM, els serveis poden escoltar a `0.0.0.0` (necessari perqu√® el tr√†nsit redirigit arribe), per√≤ **restringeix l‚Äôorigen** amb `UFW` i `pg_hba.conf` (per exemple, permetent nom√©s `10.0.2.2` en VirtualBox).  
- En entorns externs o de producci√≥, **no uses 0.0.0.0** si no √©s imprescindible: especifica IPs concretes o utilitza t√∫nels SSH o reverse proxies amb HTTPS i llistes d‚ÄôIP segures.
```
| Servei | Host IP | Host Port | Guest IP | Guest Port |
|---------|----------|-----------|-----------|-------------|
| Odoo | 127.0.0.1 | 8069 | <IP_VM> | 8069 |
| pgAdmin | 127.0.0.1 | 5050 | <IP_VM> | 5050 |
| PostgreSQL | 127.0.0.1 | 5432 | <IP_VM> | 5432 |
| MailHog | 127.0.0.1 | 8025 | <IP_VM> | 8025 |


```{admonition} ‚ÑπÔ∏è Qu√® √©s la IP 10.0.2.2 en NAT de VirtualBox?
:class: note
- El mode NAT de VirtualBox crea una xarxa virtual `10.0.2.0/24` amb:
  - **VM (guest):** 10.0.2.15 (per defecte)  
  - **Gateway/NAT virtual:** 10.0.2.2  
  - **DNS virtual:** 10.0.2.3  
- Quan redirigeixes ports (p. ex. `127.0.0.1:5432 ‚Üí 10.0.2.15:5432`), el tr√†nsit que arriba a la VM **t√© origen 10.0.2.2**.  
- Per aix√≤, si configures `pg_hba.conf` o `UFW` dins la VM, **t√© sentit permetre nom√©s 10.0.2.2**, ja que √©s el ‚Äúpont‚Äù pel qual entra la connexi√≥ des del teu host.  
- En canvi, al teu ordinador (host), mant√≠n els serveis limitats a **127.0.0.1**. En xarxes bridged o de producci√≥, ignora 10.0.2.2 i utilitza IPs reals o canals segurs (SSH, HTTPS, IP whitelists).
```


**2. PostgreSQL dins la VM:**
```bash
# postgresql.conf
listen_addresses = '*'

# pg_hba.conf
host  all  all  127.0.0.1/32    md5
host  all  all  10.0.2.2/32     md5   # IP del NAT de VirtualBox
```

**3. Tallafoc (UFW) dins la VM (opcional per√≤ recomanat en producci√≥):**

```bash
sudo ufw allow from 10.0.2.2 to any port 5432 proto tcp
sudo ufw allow from 10.0.2.2 to any port 5050 proto tcp
sudo ufw enable
```

> üß± En xarxes bridged o producci√≥, evita `0.0.0.0`: exposa nom√©s les IP necess√†ries i usa connexions segures (SSH, HTTPS, IP whitelists).
:::
---